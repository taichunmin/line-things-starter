<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    [v-cloak] {
      display: none;
    }
  </style>
</head>

<body>
  <div class="container text-monospace" id="app" v-cloak="v-cloak">
    <h1 class="text-center my-5">LINE Things Demo</h1>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <tr>
          <th class="text-right text-nowrap" style="width: 20%;">連線狀態</th>
          <td>
            <pre class="my-0">{{ text }}</pre>
          </td>
        </tr>
        <tr>
          <th class="text-right text-nowrap">裝置 ID</th>
          <td>{{ deviceId || '?' }}</td>
        </tr>
        <tr>
          <th class="text-right text-nowrap">裝置名稱</th>
          <td>{{ deviceName || '?' }}</td>
        </tr>
        <tr>
          <th class="text-right text-nowrap">裝置 PSDI</th>
          <td>{{ devicePsdi || '?' }}</td>
        </tr>
        <tr>
          <th class="text-right text-nowrap">溫度</th>
          <td>{{ temperature ? `${temperature}℃` : '?' }}</td>
        </tr>
        <tr>
          <th class="text-right text-nowrap">濕度</th>
          <td>{{ humidity ? `${humidity} %` : '?' }}</td>
        </tr>
        <tr>
          <th class="text-right text-nowrap">LED</th>
          <td class="py-2"><button class="btn btn-sm btn-success" v-if="led"><i class="fa fa-fw fa-toggle-on"></i>
              On</button><button class="btn btn-sm btn-danger" v-else="v-else"><i class="fa fa-fw fa-toggle-off"></i>
              Off</button></td>
        </tr>
      </table>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.8/vue.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/locale/zh-tw.js"></script>
  <script src="https://d.line-scdn.net/liff/1.0/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vconsole@3.2.0/dist/vconsole.min.js"></script>
  <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'UA-135565218-1');

    var vConsole = new VConsole()

    const USER_SERVICE_UUID = '5284B8C2-529B-4953-92C1-04DB36560CA6'
    const PSDI_SERVICE_UUID = 'E625601E-9E55-4597-A598-76018A0D293D'

    const TEMPERATURE_CHAR_UUID = '6136A0AB-704D-48AE-BCEF-18844B2B3311'
    const HUMIDITY_CHAR_UUID = '52842A6F-529B-4953-92C1-04DB36560CA6'
    const LED_CHAR_UUID = 'E9062E71-9E62-4BC6-B0D3-35CDCD9B027B'
    const PSDI_CHAR_UUID = '26E2B12B-85F0-4F3F-9FDD-91D114270E6E'

    let device = null

    async function getCharStr(service, uuid) {
      let characteristic = await service.getCharacteristic(uuid)
      let value = await characteristic.readValue()
      console.log(value)
      return new TextDecoder().decode(value)
    }

    async function getCharInt32(service, uuid) {
      let characteristic = await service.getCharacteristic(uuid)
      let value = await characteristic.readValue()
      return value.getInt32()
    }

    async function getCharHex(service, uuid) {
      let characteristic = await service.getCharacteristic(uuid)
      let value = await characteristic.readValue()
      return new Uint8Array(value.buffer)
        .reduce((output, byte) => output + ("0" + byte.toString(16)).slice(-2), "")
    }

    let vm = new Vue({
      el: '#app',
      mounted() {
        this.readDht()
      },
      data: {
        deviceId: null,
        deviceName: null,
        devicePsdi: null,
        led: null,
        temperature: null,
        humidity: null,
        userId: null,
        text: '尚未初始化'
      },
      methods: {
        async initLiff() {
          // https://developers.line.biz/en/docs/line-things/develop-liff-app/
          if (device) return device
          this.text = '等候 LIFF 初始化...'
          await new Promise((resolve, reject) => {
            liff.init(resolve, reject)
          })
          this.text = '等候藍芽初始化...'
          await liff.initPlugins(['bluetooth'])
          this.text = '檢查藍芽可用性...'
          await liff.bluetooth.getAvailability()
          this.text = '搜尋裝置中...'
          device = await liff.bluetooth.requestDevice()
          this.text = '裝置連線中...'
          await device.gatt.connect()
          // 設定裝置資料
          this.deviceId = device.id
          this.deviceName = device.name
          // 處理斷線事件
          device.addEventListener('gattserverdisconnected', () => {
            device = null
          });
          return device
        },
        async readDht() {
          try {
            let device = await this.initLiff()

            this.text = '讀取資料中...'
            let userService = await device.gatt.getPrimaryService(USER_SERVICE_UUID)
            // 讀取 LED 燈號
            this.led = await getCharInt32(userService, LED_CHAR_UUID)
            // 讀取溫度
            this.temperature = await getCharStr(userService, TEMPERATURE_CHAR_UUID)
            // 讀取濕度
            this.humidity = await getCharStr(userService, HUMIDITY_CHAR_UUID)
            // 讀取 psdi
            let psdiService = await device.gatt.getPrimaryService(PSDI_SERVICE_UUID)
            this.devicePsdi = await getCharHex(psdiService, PSDI_CHAR_UUID)
            this.text = '已連線'
          } catch (err) {
            this.text = err.stack
            throw err
          }
        }
      }
    })
  </script>
</body>

</html>
